# ğŸ” Authentication Flow Visual Diagrams

## ğŸ“± USER Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER AUTHENTICATION FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: FIREBASE PHONE AUTH (CLIENT-SIDE)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â”‚ (React/RN)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. User enters phone number
       â”‚ 2. Firebase.auth().signInWithPhoneNumber()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Firebase   â”‚
â”‚    Server    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Sends OTP to phone
       â”‚ 4. User enters OTP
       â”‚ 5. Firebase verifies OTP
       â”‚ 6. Returns idToken
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â”‚   (Stores    â”‚
â”‚   idToken)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 2: BACKEND JWT GENERATION
       â”‚
       â”‚ POST /api/users/firebase-login
       â”‚ Body: { idToken: "..." }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  userRoutes.js (Line 34)                                                 â”‚
â”‚  router.post('/firebase-login', loginWithFirebase)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  userController.js::loginWithFirebase() (Lines 272-325)                  â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. firebaseAdmin.auth().verifyIdToken(idToken)                 â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 2. Extract: firebaseUid, phone_number                          â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 3. Search database:                                            â”‚     â”‚
â”‚  â”‚    - User.findOne({ firebaseUid })                             â”‚     â”‚
â”‚  â”‚    - OR User.findOne({ number: phone })                        â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 4. If NOT found â†’ Create new user:                             â”‚     â”‚
â”‚  â”‚    new User({                                                   â”‚     â”‚
â”‚  â”‚      firebaseUid,                                              â”‚     â”‚
â”‚  â”‚      number: phone || `uid:${firebaseUid}`,                    â”‚     â”‚
â”‚  â”‚      isProfile: false                                          â”‚     â”‚
â”‚  â”‚    })                                                           â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 5. If found but no firebaseUid â†’ Link it:                      â”‚     â”‚
â”‚  â”‚    user.firebaseUid = firebaseUid                              â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 6. user.save()                                                  â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 7. Generate JWT:                                               â”‚     â”‚
â”‚  â”‚    jwt.sign({                                                   â”‚     â”‚
â”‚  â”‚      userId: user._id,                                         â”‚     â”‚
â”‚  â”‚      number: user.number,                                      â”‚     â”‚
â”‚  â”‚      role: 'user',                                             â”‚     â”‚
â”‚  â”‚      isProfile: user.isProfile                                 â”‚     â”‚
â”‚  â”‚    }, JWT_SECRET, { expiresIn: '7d' })                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Response   â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚ userId      â”‚
                 â”‚ number      â”‚
                 â”‚ isProfile   â”‚
                 â”‚ token â—„â”€â”€â”€â”€ JWT (7 days)
                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Client    â”‚
                 â”‚  Stores JWT â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 3: ACCESSING PROTECTED ROUTES

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ PUT /api/users/profile
      â”‚ Headers: Authorization: Bearer <jwt-token>
      â”‚ Body: { firstname: "John", lastname: "Doe" }
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  userRoutes.js (Line 38)                                               â”‚
â”‚  router.put('/profile', verifyAuth(['user']), upload.single(...),     â”‚
â”‚             updateProfile)                                             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE 1: verifyAuth(['user']) - middleware/auth.js               â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. Extract token from Authorization header                   â”‚     â”‚
â”‚  â”‚    token = req.header('Authorization')?.replace('Bearer ','')â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 2. Verify JWT signature:                                     â”‚     â”‚
â”‚  â”‚    decoded = jwt.verify(token, JWT_SECRET)                   â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 3. Normalize req.user:                                       â”‚     â”‚
â”‚  â”‚    req.user = {                                              â”‚     â”‚
â”‚  â”‚      id: decoded.userId,                                     â”‚     â”‚
â”‚  â”‚      userId: decoded.userId,                                 â”‚     â”‚
â”‚  â”‚      role: decoded.role,  // 'user'                          â”‚     â”‚
â”‚  â”‚      number: decoded.number,                                 â”‚     â”‚
â”‚  â”‚      isProfile: decoded.isProfile                            â”‚     â”‚
â”‚  â”‚    }                                                          â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 4. Check role:                                               â”‚     â”‚
â”‚  â”‚    if (req.user.role !== 'user') return 403                  â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 5. next() âœ“                                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE 2: multer - upload.single('profileImage')                  â”‚
â”‚  - Handles multipart/form-data                                         â”‚
â”‚  - Stores image in memory buffer                                       â”‚
â”‚  - Sets req.file if image present                                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER: userController.js::updateProfile() (Lines 66-161)         â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. Get userId from req.user.userId                           â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 2. const user = await User.findById(userId)                  â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 3. Update profile fields:                                    â”‚     â”‚
â”‚  â”‚    if (firstname) user.firstname = firstname                 â”‚     â”‚
â”‚  â”‚    if (lastname) user.lastname = lastname                    â”‚     â”‚
â”‚  â”‚    if (email) user.email = email                             â”‚     â”‚
â”‚  â”‚    if (dob) user.dob = dob                                   â”‚     â”‚
â”‚  â”‚    if (gender) user.gender = gender                          â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 4. If req.file (image):                                      â”‚     â”‚
â”‚  â”‚    - uploadImageToS3(req.file, 'profile-images')             â”‚     â”‚
â”‚  â”‚    - deleteFromS3(user.profileImage) // old image            â”‚     â”‚
â”‚  â”‚    - user.profileImage = newS3URL                            â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 5. await user.save()                                         â”‚     â”‚
â”‚  â”‚    â†“                                                          â”‚     â”‚
â”‚  â”‚ 6. Return updated user (without OTP)                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Response   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ statusCode  â”‚
â”‚ success     â”‚
â”‚ message     â”‚
â”‚ data: {     â”‚
â”‚   user {...}â”‚
â”‚ }           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¨â€ğŸ’¼ ADMIN Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ADMIN AUTHENTICATION FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FIREBASE ADMIN LOGIN (RECOMMENDED)

STEP 1: FIREBASE PHONE AUTH (Same as User)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â”‚ (Admin App)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Firebase phone auth
       â”‚ 2. Get idToken
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client     â”‚
â”‚   (Stores    â”‚
â”‚   idToken)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 2: BACKEND JWT GENERATION
       â”‚
       â”‚ POST /api/admin/firebase-login
       â”‚ Body: { idToken: "..." }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  adminRoutes.js (Line 7)                                                 â”‚
â”‚  router.post('/firebase-login', adminFirebaseLogin)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  adminController.js::adminFirebaseLogin() (Lines 96-169)                 â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. firebaseAdmin.auth().verifyIdToken(idToken)                 â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 2. Extract: firebaseUid, phone_number                          â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 3. Search database:                                            â”‚     â”‚
â”‚  â”‚    - Admin.findOne({ firebaseUid, isActive: true })            â”‚     â”‚
â”‚  â”‚    - OR Admin.findOne({ number: phone, isActive: true })       â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 4. If NOT found â†’ Return 401 Unauthorized âš ï¸                   â”‚     â”‚
â”‚  â”‚    (DOES NOT auto-create admins - security measure)            â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 5. If found but no firebaseUid â†’ Link it:                      â”‚     â”‚
â”‚  â”‚    admin.firebaseUid = firebaseUid                             â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 6. admin.updateLastLogin()                                      â”‚     â”‚
â”‚  â”‚    â†“                                                            â”‚     â”‚
â”‚  â”‚ 7. Generate JWT:                                               â”‚     â”‚
â”‚  â”‚    jwt.sign({                                                   â”‚     â”‚
â”‚  â”‚      adminId: admin._id,                                       â”‚     â”‚
â”‚  â”‚      number: admin.number,                                     â”‚     â”‚
â”‚  â”‚      role: 'admin'                                             â”‚     â”‚
â”‚  â”‚    }, JWT_SECRET, { expiresIn: '24h' })                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Response   â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                 â”‚ adminId     â”‚
                 â”‚ number      â”‚
                 â”‚ role        â”‚
                 â”‚ token â—„â”€â”€â”€â”€ JWT (24 hours)
                 â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Client    â”‚
                 â”‚  Stores JWT â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IMPORTANT: ADMIN MUST BE PRE-CREATED

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  To create admin in database:                                          â”‚
â”‚                                                                         â”‚
â”‚  const admin = new Admin({                                             â”‚
â”‚    number: '9000000000',                                               â”‚
â”‚    role: 'admin',                                                      â”‚
â”‚    isActive: true                                                      â”‚
â”‚  });                                                                   â”‚
â”‚  await admin.save();                                                   â”‚
â”‚                                                                         â”‚
â”‚  âœ… Demo admin created: 9000000000                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete Middleware Chain Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    REQUEST LIFECYCLE WITH MIDDLEWARE                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CLIENT REQUEST
     â”‚
     â”‚ PUT /api/users/profile
     â”‚ Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
     â”‚ Content-Type: multipart/form-data
     â”‚ Body: { firstname: "John", lastname: "Doe", profileImage: <file> }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EXPRESS SERVER                                                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ROUTE MATCHING: userRoutes.js                                         â”‚
â”‚                                                                         â”‚
â”‚  router.put(                                                           â”‚
â”‚    '/profile',                       // âœ“ Matches                      â”‚
â”‚    verifyAuth(['user']),             // Middleware 1                   â”‚
â”‚    upload.single('profileImage'),    // Middleware 2                   â”‚
â”‚    updateProfile                     // Controller                     â”‚
â”‚  );                                                                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE 1: verifyAuth(['user'])                                    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Authorization: Bearer eyJ... â”€â”€â”€â”€â–º Extract token             â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ jwt.verify(token, JWT_SECRET) â”€â”€â–º Decode:                    â”‚      â”‚
â”‚  â”‚   {                                                           â”‚      â”‚
â”‚  â”‚     userId: "68e798d82e0d913d4191d783",                      â”‚      â”‚
â”‚  â”‚     number: "+919000000000",                                 â”‚      â”‚
â”‚  â”‚     role: "user",                                            â”‚      â”‚
â”‚  â”‚     isProfile: false,                                        â”‚      â”‚
â”‚  â”‚     iat: 1696856008,                                         â”‚      â”‚
â”‚  â”‚     exp: 1697460808                                          â”‚      â”‚
â”‚  â”‚   }                                                           â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ req.user = {                                                  â”‚      â”‚
â”‚  â”‚   id: "68e798d82e0d913d4191d783",                            â”‚      â”‚
â”‚  â”‚   userId: "68e798d82e0d913d4191d783",                        â”‚      â”‚
â”‚  â”‚   role: "user",                                              â”‚      â”‚
â”‚  â”‚   number: "+919000000000",                                   â”‚      â”‚
â”‚  â”‚   isProfile: false                                           â”‚      â”‚
â”‚  â”‚ }                                                             â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ Check: req.user.role in ['user'] â”€â”€â–º âœ“ PASS                  â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ next() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIDDLEWARE 2: multer.single('profileImage')                           â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Parse multipart/form-data                                    â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ req.body = {                                                  â”‚      â”‚
â”‚  â”‚   firstname: "John",                                         â”‚      â”‚
â”‚  â”‚   lastname: "Doe"                                            â”‚      â”‚
â”‚  â”‚ }                                                             â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ req.file = {                                                  â”‚      â”‚
â”‚  â”‚   fieldname: 'profileImage',                                 â”‚      â”‚
â”‚  â”‚   originalname: 'photo.jpg',                                 â”‚      â”‚
â”‚  â”‚   mimetype: 'image/jpeg',                                    â”‚      â”‚
â”‚  â”‚   buffer: <Buffer ff d8 ff e0 ...>,                          â”‚      â”‚
â”‚  â”‚   size: 245832                                               â”‚      â”‚
â”‚  â”‚ }                                                             â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ next() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTROLLER: updateProfile()                                           â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ const userId = req.user.userId // "68e798d82e0d913d4191d783" â”‚      â”‚
â”‚  â”‚ const { firstname, lastname } = req.body                     â”‚      â”‚
â”‚  â”‚ const profileImage = req.file                                â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ const user = await User.findById(userId)                     â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ user.firstname = "John"                                      â”‚      â”‚
â”‚  â”‚ user.lastname = "Doe"                                        â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ if (profileImage) {                                          â”‚      â”‚
â”‚  â”‚   const s3Url = await uploadImageToS3(profileImage, ...)     â”‚      â”‚
â”‚  â”‚   await deleteFromS3(user.profileImage) // old               â”‚      â”‚
â”‚  â”‚   user.profileImage = s3Url                                  â”‚      â”‚
â”‚  â”‚ }                                                             â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ await user.save()                                            â”‚      â”‚
â”‚  â”‚                                                               â”‚      â”‚
â”‚  â”‚ res.status(200).json({                                       â”‚      â”‚
â”‚  â”‚   statusCode: 200,                                           â”‚      â”‚
â”‚  â”‚   success: true,                                             â”‚      â”‚
â”‚  â”‚   message: "Profile updated successfully",                   â”‚      â”‚
â”‚  â”‚   data: user                                                 â”‚      â”‚
â”‚  â”‚ })                                                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESPONSE TO CLIENT                                                     â”‚
â”‚                                                                         â”‚
â”‚  {                                                                      â”‚
â”‚    "statusCode": 200,                                                  â”‚
â”‚    "success": true,                                                    â”‚
â”‚    "message": "Profile updated successfully",                          â”‚
â”‚    "data": {                                                           â”‚
â”‚      "_id": "68e798d82e0d913d4191d783",                                â”‚
â”‚      "firebaseUid": "abc123...",                                       â”‚
â”‚      "number": "+919000000000",                                        â”‚
â”‚      "firstname": "John",                                              â”‚
â”‚      "lastname": "Doe",                                                â”‚
â”‚      "email": "[email protected]",                                          â”‚
â”‚      "isProfile": true,                                                â”‚
â”‚      "profileImage": "https://cartunoprod.s3...photo.jpg",             â”‚
â”‚      "createdAt": "2025-10-09T10:00:00.000Z",                          â”‚
â”‚      "updatedAt": "2025-10-09T11:13:28.762Z"                           â”‚
â”‚    }                                                                   â”‚
â”‚  }                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ JWT Token Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           JWT TOKEN LIFECYCLE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER TOKEN
â•â•â•â•â•â•â•â•â•â•â•

CREATION (7 days validity)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  jwt.sign({                                                          â”‚
â”‚    userId: "68e798d82e0d913d4191d783",                              â”‚
â”‚    number: "+919000000000",                                         â”‚
â”‚    role: "user",                                                    â”‚
â”‚    isProfile: false                                                 â”‚
â”‚  }, "your-secret-key", { expiresIn: "7d" })                         â”‚
â”‚                                                                      â”‚
â”‚  â†“                                                                   â”‚
â”‚                                                                      â”‚
â”‚  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.                              â”‚
â”‚  eyJ1c2VySWQiOiI2OGU3OThkODJlMGQ5MTNkNDE5MWQ3ODMiLCJudW1iZ         â”‚
â”‚  XIiOiIrOTE5MDAwMDAwMDAwIiwicm9sZSI6InVzZXIiLCJpc1Byb2ZpbGU       â”‚
â”‚  iOmZhbHNlLCJpYXQiOjE2OTY4NTYwMDgsImV4cCI6MTY5NzQ2MDgwOH0.        â”‚
â”‚  SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c                        â”‚
â”‚                                                                      â”‚
â”‚  PARTS:                                                              â”‚
â”‚  [Header].[Payload].[Signature]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STORAGE (Client)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  localStorage.setItem('token', token)                                â”‚
â”‚  // or                                                               â”‚
â”‚  AsyncStorage.setItem('token', token) // React Native               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USAGE (Every API Request)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  fetch('/api/users/profile', {                                       â”‚
â”‚    headers: {                                                        â”‚
â”‚      'Authorization': `Bearer ${token}`                              â”‚
â”‚    }                                                                 â”‚
â”‚  })                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VERIFICATION (Server)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  const decoded = jwt.verify(token, "your-secret-key")                â”‚
â”‚                                                                      â”‚
â”‚  // If expired or invalid â†’ throws error â†’ 401 response             â”‚
â”‚  // If valid â†’ returns decoded payload                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ADMIN TOKEN
â•â•â•â•â•â•â•â•â•â•â•

CREATION (24 hours validity)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  jwt.sign({                                                          â”‚
â”‚    adminId: "68e798d82e0d913d4191d783",                             â”‚
â”‚    number: "9000000000",                                            â”‚
â”‚    role: "admin"                                                    â”‚
â”‚  }, "your-secret-key", { expiresIn: "24h" })                        â”‚
â”‚                                                                      â”‚
â”‚  Same format but shorter expiration â±ï¸                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¨ Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ERROR SCENARIOS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. NO TOKEN PROVIDED
   Request: GET /api/users/profile (no Authorization header)
   â†“
   verifyAuth middleware
   â†“
   Response: 401 { "success": false, "message": "Access denied. No token provided." }

2. INVALID TOKEN (malformed)
   Request: Authorization: Bearer invalid_token_string
   â†“
   jwt.verify() throws error
   â†“
   Response: 401 { "success": false, "message": "Invalid token." }

3. EXPIRED TOKEN
   Request: Authorization: Bearer <expired-token>
   â†“
   jwt.verify() throws TokenExpiredError
   â†“
   Response: 401 { "success": false, "message": "Invalid token." }

4. WRONG ROLE
   Request: User token accessing admin-only route
   â†“
   verifyAuth(['admin']) checks req.user.role
   â†“
   Response: 403 { "success": false, "message": "Access denied. Required roles: admin" }

5. FIREBASE TOKEN VERIFICATION FAILS
   Request: POST /api/users/firebase-login { idToken: "invalid" }
   â†“
   firebaseAdmin.auth().verifyIdToken() throws error
   â†“
   Response: 401 { "success": false, "message": "Invalid Firebase ID token" }

6. ADMIN NOT PRE-CREATED
   Request: POST /api/admin/firebase-login (valid Firebase token but no admin in DB)
   â†“
   Admin.findOne() returns null
   â†“
   Response: 401 { "success": false, "message": "Unauthorized admin" }

7. INACTIVE ADMIN
   Request: Admin login with isActive: false
   â†“
   Admin found but isActive check fails
   â†“
   Response: 401 { "success": false, "message": "Account is deactivated" }
```

---

## âœ… Summary Checklist

```
USER AUTHENTICATION:
â˜‘ Client performs Firebase phone auth
â˜‘ Client receives Firebase idToken
â˜‘ Client sends idToken to POST /api/users/firebase-login
â˜‘ Backend verifies idToken with Firebase Admin SDK
â˜‘ Backend creates user if not exists (auto-registration)
â˜‘ Backend generates JWT with 7-day expiration
â˜‘ Client stores JWT
â˜‘ Client includes JWT in all protected requests
â˜‘ Middleware verifies JWT and checks role
â˜‘ Controller accesses user via req.user

ADMIN AUTHENTICATION:
â˜‘ Client performs Firebase phone auth
â˜‘ Client receives Firebase idToken
â˜‘ Client sends idToken to POST /api/admin/firebase-login
â˜‘ Backend verifies idToken with Firebase Admin SDK
â˜‘ Backend finds existing admin (does NOT auto-create)
â˜‘ Backend checks admin.isActive === true
â˜‘ Backend generates JWT with 24-hour expiration
â˜‘ Client stores JWT
â˜‘ Admin must be pre-created in database

SECURITY:
â˜‘ JWT tokens are signed with secret key
â˜‘ Tokens include expiration time
â˜‘ Middleware validates token on every request
â˜‘ Role-based access control enforced
â˜‘ Admin accounts cannot be auto-created
â˜‘ Inactive admins cannot login
â˜‘ Sensitive data (OTP, password) excluded from responses
â˜‘ Firebase handles OTP delivery securely
```

